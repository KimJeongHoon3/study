effective_java_동시성

- 아이템78_공유 중인 가변 데이터는 동기화해 사용하라
  - 동기화에는 두가지 중요한 기능이 있음
    - 베타적 실행
      - 한 스레드가 변경하는 중이라서 상태가 일관되지 않은 순간의 객체를 다른 스레드가 보지 못하게 막는 용도 (간단하게말하면, 락을 획득한놈만 상태를 변경가능하기에, 내가 변경하고 있는 와중에 다른놈이 변경 못하는것)
    - 가시성 확보
      - 동기화된 메서드나 블록에 들어간 스레드가 같은 락의 보호하에 수행된 모든 이전 수정의 최종결과를 보게해줌
        - long이나 double외의 변수는 언제라도 변경된 값을 한번에 읽고 쓸 수 있다.(원자적) 즉, 동기화 없이 수정하는 중이라도 항상 어떤 스레드가 정상적으로 저장한 값을 온전히 읽어온다(잘리거나 하지않는다!)
        - 하지만, 스레드가 저장한 값이 다른 스레드에게 "보이는가"를 반드시 보장하지않는다! (자바언어명세)
          - 쉽게 이야기하면, 특정 스레드가 변수의 값을 변경했을때, 다른 스레드가 그 변경한 값을 못 읽을 수 있다는것..
          - 한 스레드가 만든 변화가 다른 스레드에게 언제 어떻게 보이는지를 규정한 자바의 메모리 모델때문이라함 
            - <span style="color:red">뭔소리인지 좀더 찾아봐야할듯<span>
          - ex. 무한 루프를 돌고 있는 스레드가, boolean을 활용하여 스레드를 멈출때 
            - 예제코드넣기
            
      - 가시성 확보를 위해 쓰기와 읽기 모두 sychronized 키워드를 사용는것보다 좋은 성능을 발휘하는게 volatile!
        - volatile은 배타적 수행과 관계없다!
          - 멀티스레드 환경에서 값을 순차적으로 증가시켜야 한다면, 반드시 배타적 수행을 위해 synchronized 키워드를 사용해야한다
            - 물론, 이런 synchonrized 키워드에 대한 개선으로 AtomicInteger가 있다
              - java.util.concurrent.atomic 패키지참고 (락 없이도 스레드 안전한 프로그래밍 지원해주는 클래스들이 있음)
        - 하지만, 항상 가장 최근에 기록된 값을 읽게 됨을 보장한다
          - cpu 캐시가 아닌 메모리에서 가져온다!
          - JVM이 최적화를 통해 변수의 읽기와 쓰기를 재정렬하는 경우, volatile 키워드는 이러한 재정렬을 방지하여 변수에 대한 읽기와 쓰기의 순서를 보장
        - 스레드간 통신용도로만 사용된다면 적극 사용할것! (ex. 위의 스레드 멈출때 사용하는 boolean 같은 경우 )
  - 위에서 이야기한 동시성 문제를 피하려면?
    - 가변데이터 공유하지않는것!
      - 불변 데이터만 공유하거나 아무것도 공유 노
      - 가변 데이터는 단일 스레드에서만쓰도록..
        - 만약, 해당 정책이 있다면 꼭 문서에 남길것!!
  - 한 스레드가 데이터를 다 수정한 후 다른 스레드에 공유할 때는, 해당 객체에서 공유하는 부분만 동기화하자
    - 객체를 다시 수정할 일이 생기기전까지 다른 스레드들은 동기화 없이 자유롭게 값을 읽을 수 있음
    - 이런 객체를 사실상불변(effectively immutable)이라하고, 다른 스레드에 이를 건네는 행위를 안전 발행(safe publication)이라한다
      - 안전발행 방법?
        - 초기화 과정에서 객체를 정적 필드, volatile 필드, final 필드, 혹은 보통의 락을 통해 접근하는 필드에 저장
        - 동시성 컬렉션에 저장.. 
          - ex. ConcurrentHashMap?
      - <span style="color:red">좀더 정확한 개념정리 필요<span>
  - 기타 팁
    - long, double 외의 변수를 읽고 쓰는 동작은 원자적(atomic)임
    - AtomicInteger는 어떻게 동작할까?
      - CAS (Compare And Swap)
      - <span style="color:red">정리한 내용추가</span>